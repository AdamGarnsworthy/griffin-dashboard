<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>GRIFFIN Dashboard Testing</title>

        <!--libraries-->
        <script src="../scripts/qunit.js"></script>

        <!--style-->
        <link rel="stylesheet" href="../css/qunit.css">
        
        <script src='../scripts/helpers.js' type="text/javascript"></script>
        <script src='../templates/daq-monitor/daq-monitor.js' type="text/javascript"></script>
        <script src='../templates/hv-monitor/hv-monitor.js' type="text/javascript"></script>

    </head>
    <body>
        <div id="qunit"></div>
        <div id="qunit-fixture">

            <div id='deletion-target'></div>

            <div id='position-test' style='margin:50px; padding:100px'></div>

            <select id='read-select'>
                <option value='0'>Lemon</option>
                <option value='1'>Strawberry</option>
                <option value='2'>Chocolate</option>
            </select>
        </div>

        <script>
            // bump to a well-defined query string
            var query = '?test=xyz';
            if(location.search !== query)
                location.search = query;


            QUnit.module('DAQ', {
                beforeEach: function(){
                    dataStore = {
                        ODB: {
                            DAQ: {
                                MSC: {
                                    MSC: [0x230A, 0x230B],
                                    chan: ['GRG--', 'XXX--']
                                },

                                detectorNames: {
                                    'GR': 'GRIFFIN',
                                    'ZD': 'Zero-Degree Scintillator',
                                    'SE': 'SCEPTAR',
                                    'DS': 'DESCANT',
                                    'PA': 'PACES',
                                    'DA': 'DANTE'
                                }
                            }
                        }
                    };

                    regenerateDatastructure(true)
                },

                afterEach: function(){
                    delete dataStore;
                }
            })

            QUnit.test('single-sort', function(assert){
                //check that individual objects returned by unpackDAQ get sorted into the summary correctly

                sortDAQitem('GRG06BN00A', {
                    MSC: 0x230A,
                    threshold: 100,
                    trigReq: 1000,
                    trigAcpt: 732
                });

                assert.equal(1000, dataStore.ODB.DAQ.summary.master.requests)
                assert.equal(732, dataStore.ODB.DAQ.summary.master.accepts)
                assert.equal(1000, dataStore.ODB.DAQ.summary.collectors.requests[2])
                assert.equal(732, dataStore.ODB.DAQ.summary.collectors.accepts[2])
                assert.equal(1000, dataStore.ODB.DAQ.summary.digitizers.requests[2][3])
                assert.equal(732, dataStore.ODB.DAQ.summary.digitizers.accepts[2][3])
                assert.equal(1000, dataStore.ODB.DAQ.summary.channels.requests[2][3][10])
                assert.equal(732, dataStore.ODB.DAQ.summary.channels.accepts[2][3][10])
                assert.equal(1000, dataStore.ODB.DAQ.summary.detectors.requests[0])
                assert.equal(732, dataStore.ODB.DAQ.summary.detectors.accepts[0])
            });

            QUnit.test('sum-sort', function(assert){
                //check that multiple objects returned by unpackDAQ get sorted into the summary correctly

                sortDAQitem('GRG06BN00A', {
                    MSC: 0x230A,
                    threshold: 100,
                    trigReq: 1000,
                    trigAcpt: 732
                });

                sortDAQitem('XXX06BN00A', {
                    MSC: 0x230B,
                    threshold: 101,
                    trigReq: 500,
                    trigAcpt: 200
                });

                assert.equal(1500, dataStore.ODB.DAQ.summary.master.requests)
                assert.equal(932, dataStore.ODB.DAQ.summary.master.accepts)
                assert.equal(1500, dataStore.ODB.DAQ.summary.collectors.requests[2])
                assert.equal(932, dataStore.ODB.DAQ.summary.collectors.accepts[2])
                assert.equal(1500, dataStore.ODB.DAQ.summary.digitizers.requests[2][3])
                assert.equal(932, dataStore.ODB.DAQ.summary.digitizers.accepts[2][3])
                assert.equal(1000, dataStore.ODB.DAQ.summary.channels.requests[2][3][10])
                assert.equal(732, dataStore.ODB.DAQ.summary.channels.accepts[2][3][10])
                assert.equal(500, dataStore.ODB.DAQ.summary.channels.requests[2][3][11])
                assert.equal(200, dataStore.ODB.DAQ.summary.channels.accepts[2][3][11])
                assert.equal(1000, dataStore.ODB.DAQ.summary.detectors.requests[0])
                assert.equal(732, dataStore.ODB.DAQ.summary.detectors.accepts[0])
                assert.equal(500, dataStore.ODB.DAQ.summary.detectors.requests[1])
                assert.equal(200, dataStore.ODB.DAQ.summary.detectors.accepts[1])
            });

            ////////////////////////////////////////////////////

            QUnit.module('HV', {
                beforeEach: function(){
                    dataStore = {
                        ODB: {},
                        HV: {
                            crates: {}
                        }
                    }
                },

                afterEach: function(){
                    delete dataStore;
                }
            })

            QUnit.test('cratemap unpacking', function(assert){
                //check that cratempas are unpacked correctly

                var cratemap = unpackHVCrateMap(1141182468);
                assert.deepEqual(cratemap, [12, 0, 12, 0, 0, 0, 12, 12, 0, 12, 0, 0, 0, 0, 12, 0]);

                cratemap = unpackHVCrateMap(1145044994);
                assert.deepEqual(cratemap, [12, 0, 12, 0, 12, 0]);

                cratemap = unpackHVCrateMap(-2004877310);
                assert.deepEqual(cratemap, [24,0,24,0,24,0]);

            });

            /////////////////////////////////////////////

            QUnit.module('helpers',{})

            QUnit.test('delete a node', function(assert){
                assert.notEqual(document.getElementById('deletion-target'), null);
                deleteNode('deletion-target');
                assert.strictEqual(document.getElementById('deletion-target'), null);
            });

            QUnit.test('base 10 log', function(assert){
                assert.strictEqual(Math.log10(1), 0);
                assert.strictEqual(Math.log10(10), 1);
                assert.strictEqual(Math.log10(0), -Infinity);
            });

            QUnit.test('dom element postioning', function(assert){
                assert.deepEqual(getPosition(window.body), {x:0,y:0});
                assert.deepEqual(getPosition(document.getElementById('position-test')), {x:-9950,y:-9950}); //note this is contingent on qunit pushing #qunit-fixture out to -10000, -10000 - if that css changes, this test will break
            });

            QUnit.test('is numeric', function(assert){

                assert.strictEqual(isNumeric(0), true);
                assert.strictEqual(isNumeric('0'), false);
                assert.strictEqual(isNumeric(0.0), true);
                assert.strictEqual(isNumeric(null), false);
                assert.strictEqual(isNumeric(NaN), false);
                assert.strictEqual(isNumeric(undefined), false);
                assert.strictEqual(isNumeric(Infinity), false);
            });

            QUnit.test('number style', function(assert){

                assert.strictEqual(prettyNumber(1000000), '1.000 M');
                assert.strictEqual(prettyNumber(999999), '999.999 k');
            });

            QUnit.test('select value reader', function(assert){
                assert.strictEqual(selected('read-select'), '0');
                assert.strictEqual(selected('read-select', true), 'Lemon');
            });

            QUnit.test('query string extraction', function(assert){
                assert.strictEqual(getParameterByName('test'), 'xyz');
                assert.strictEqual(getParameterByName('nope'), '');
            });


        </script>
      </body>
</html>