#HV Summary Tool

`<widget-HV>` supplies a top level summary view of any number of CAEN HV crates.  The element will automatically detect and render all such crates controlled through the ODB via [this CAEN driver](https://github.com/GRIFFINCollaboration/MIDASfrontends), so long as these frontends are named `HV-0`, `HV-1`,...

##Attributes

 - `MIDAS`: the `host`:`port` serving MIDAS' web interface, with no extra window-dressing, ie `awesomecomp.triumf.ca:1337`

##Query String Navigation
After setting itself up, `<widget-HV>` will internally navigate to a channel indicated in the query string.  For example, `?crate=1&channel=GRG01RN00X` would cause the HV widget to immediately highlight `GRG01RN00X` in crate HV-1.

If no valid query string parameters are found, the widget will display crate HV-0 and wait for the user to choose a channel to highlight.

##Instantiation, DOM and Member Data

`<widget-HV>` automatically configures itself upon instantiation by declaring some member variables, autodetecting how many HV crates are visible in the ODB, inserting itself into `window.refreshTargets` for inclusion in the main event loop, and setting up its internal DOM structure via `instantiateMonitors()`.

###Member Data
 - `this.driftTolerance`, default 0.05: relative amount a channel's demanded and required voltage (as taken from the ODB's `Variables/Demand` and `Variables/Measured`) can differ by before a HV drift alarm is thrown.
 - `this.temperatureMax`, default 40: channels will throw an overheat warning if their temperature exceeds this in Celcius.
 - `this.cratePop` (autodetected from ODB): array of arrays representing the card population of each crate.  `[[1,1,1,1,2], [4,0,0,0,0,4,4]]` would, for example, indicate that the crate controlled by `HV-0` has 4 12 channel (ie one slot) cards, followed by a 24 channel card, and `HV-1` has a 48 channel card, 4 empty slots, and then two more 4 channel cards.  Note that every slot in a crate is accounted for in this way; the example above represents a 6 slot crate and a 16 slot crate.  Only 0 (empty), 1 (12 chan), 2 (24 chan) and 4 (48 chan) cards are supported.
 - `this.cardNames` (autogenerated): array of arrays of card names.  By default, set to 'Slot n', where n is the first slot occupied by the card.
 - `this.crateNames` (autogenerated): array of crate names, defaults to Crate_n
 - `this.HVgrid`: array of `<x-waffle>` elements for representing the crates, one per crate.

###DOM Structure
`<widget-HV>` builds its internal DOM as:

```
--------------------------------------------------
div navigation / header
  h1 HV Control
  [radio inputs for x-deck navigation]
--------------------------------------------------
div DeckWrap
  x-deck
    x-card (one per crate)
      x-waffle (one per card)
--------------------------------------------------

```

##Member Functions
####`changeView(index)` 
Shuffles the x-deck to index (ie to `HV-index`).

####`clickCell(cellName)`
Highlights a clicked cell with a red border, and if a `widget-HVcontrol` element is found on the page, fires a `postHVchan` at it bearing the information corresponding to this cell.

####`findChannelName(row, col, cardArray, nameArray)`
Given `nameArray` from `Settings/Names` in the ODB, and an array `cardArray` such as the crate maps found in `this.cratePop`, return the name that should be assigned to the cell at `row`, `col`.  Primary cells (ie row 0) are named `No Primary` for all but 48-channel cards, and cells corresponding to empty slots are all named `EMPTY SLOT`.

####`generateCardNames(cardArray)`
Given an array from `this.cratePop`, generate the default names for the corresponding crate's slots.

####`instantiateMonitors()` 
For use on creation, once the ODB has reported back with the minimum necessary information to define the HV view.  Builds the DOM described above, instantiates and sets up all the `x-waffles` needed, and navigates to the cell indicated by the query string, if present.

####`mapData(crate, responseText)`
Designed as the callback to fetching the `Equipment/HV-n` from the ODB.  `crate` is the crate index, and `responseText` is the raw response from the XHR call to the ODB.

`mapData` is where decisions are made on what status color is reported for this cell.  The logic is as follows:
 - An alarm condition will be raised if ANY of:
  - Voltage doesn't match its nominal value AND the channel isn't ramping AND the channel hasn't tripped off
  - Any error code is recieved from the board AND the channel hasn't tripped off
  - The channel is overheating (temp > `this.temperatureMax`)
 - The channel will report as ramping if it is indeed ramping, AND is not tripped AND is not overheating.
 - The channel will report as tripped if any internal or external trip warning has been received
 - The channel will report as off if it is off with no other on-board warnings.

Finally, `mapData` also refreshes the tooltip content of each cell it updates.

####`unpackHVcrateMap(crateMap)`
Used to decode the crate map stored by the frontend in `Settings/Devices/sy2527/DD/crateMap`, and return an array appropriate for populating `this.cratePop`.  Decoding algorithm is descibed in detail in this function's inline comments.

####`update()`
Re-grabs each `Equipment/HV-n` directory from the ODB, and hands them off to `mapData` to decide what to do with them.
